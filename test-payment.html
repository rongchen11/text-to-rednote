<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Pay æ”¯ä»˜æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #1890ff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #40a9ff;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .info {
            background: #f0f9ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Z-Pay æ”¯ä»˜ç³»ç»Ÿæµ‹è¯•å·¥å…·</h1>
        <p>ç”¨äºæµ‹è¯•Z-Payæ”¯ä»˜æ¥å£çš„é›†æˆæƒ…å†µ</p>

        <div class="form-group">
            <label>å•†å“åç§°</label>
            <input type="text" id="productName" value="ç§¯åˆ†å……å€¼-æ ‡å‡†åŒ…" placeholder="å•†å“åç§°">
        </div>

        <div class="form-group">
            <label>è®¢å•é‡‘é¢ï¼ˆå…ƒï¼‰</label>
            <input type="number" id="amount" value="5.00" step="0.01" placeholder="è®¢å•é‡‘é¢">
        </div>

        <div class="form-group">
            <label>ç§¯åˆ†æ•°é‡</label>
            <input type="number" id="credits" value="500" placeholder="ç§¯åˆ†æ•°é‡">
        </div>

        <div class="form-group">
            <label>æ”¯ä»˜æ–¹å¼</label>
            <select id="paymentType">
                <option value="wxpay">å¾®ä¿¡æ”¯ä»˜</option>
                <option value="alipay">æ”¯ä»˜å®</option>
            </select>
        </div>

        <div class="form-group">
            <label>å•†æˆ·ID (PID)</label>
            <input type="text" id="pid" value="demo_pid" placeholder="å•†æˆ·å”¯ä¸€æ ‡è¯†">
        </div>

        <div class="form-group">
            <label>å•†æˆ·å¯†é’¥ (KEY)</label>
            <input type="password" id="key" value="demo_key" placeholder="å•†æˆ·å¯†é’¥">
        </div>

        <div class="form-group">
            <label>å›è°ƒåœ°å€</label>
            <input type="url" id="notifyUrl" value="http://localhost:5173/api/payment/zpay-webhook" placeholder="å¼‚æ­¥é€šçŸ¥åœ°å€">
        </div>

        <div class="form-group">
            <label>è·³è½¬åœ°å€</label>
            <input type="url" id="returnUrl" value="http://localhost:5173/payment/success" placeholder="æ”¯ä»˜å®Œæˆè·³è½¬åœ°å€">
        </div>

        <button onclick="generatePaymentUrl()">ç”Ÿæˆæ”¯ä»˜é“¾æ¥</button>
        <button onclick="testSignature()">æµ‹è¯•ç­¾åç®—æ³•</button>
        <button onclick="simulateCallback()">æ¨¡æ‹Ÿå›è°ƒ</button>

        <div id="result"></div>
    </div>

    <script>
        // MD5åŠ å¯†å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼Œä»…ç”¨äºæµ‹è¯•ï¼‰
        function md5(string) {
            // æ³¨æ„ï¼šè¿™é‡Œåº”è¯¥ä½¿ç”¨çœŸæ­£çš„MD5åº“ï¼Œè¿™åªæ˜¯ç¤ºä¾‹
            return 'test_signature_' + string.length;
        }

        // ç”Ÿæˆç­¾åå‚æ•°å­—ç¬¦ä¸²
        function getVerifyParams(params) {
            const filteredParams = {};
            Object.keys(params).forEach(key => {
                if (params[key] !== '' && params[key] !== null && params[key] !== undefined && 
                    key !== 'sign' && key !== 'sign_type') {
                    filteredParams[key] = params[key];
                }
            });
            
            const sortedKeys = Object.keys(filteredParams).sort();
            return sortedKeys.map(key => `${key}=${filteredParams[key]}`).join('&');
        }

        // ç”Ÿæˆæ”¯ä»˜é“¾æ¥
        function generatePaymentUrl() {
            const params = {
                name: document.getElementById('productName').value,
                money: parseFloat(document.getElementById('amount').value).toFixed(2),
                type: document.getElementById('paymentType').value,
                out_trade_no: 'ORDER' + Date.now(),
                notify_url: document.getElementById('notifyUrl').value,
                pid: document.getElementById('pid').value,
                return_url: document.getElementById('returnUrl').value,
                param: `ç§¯åˆ†å……å€¼-${document.getElementById('credits').value}ç§¯åˆ†`,
                sign_type: 'MD5'
            };

            const paramString = getVerifyParams(params);
            const key = document.getElementById('key').value;
            const sign = md5(paramString + key); // å®é™…åº”ç”¨ä¸­ä½¿ç”¨çœŸæ­£çš„MD5

            const fullUrl = `https://z-pay.cn/submit.php?${paramString}&sign=${sign}&sign_type=MD5`;

            showResult(`ç”Ÿæˆçš„æ”¯ä»˜å‚æ•°ï¼š
å‚æ•°å­—ç¬¦ä¸²: ${paramString}
ç­¾å: ${sign}
å®Œæ•´URL: ${fullUrl}

æ³¨æ„ï¼šè¿™æ˜¯æµ‹è¯•ç”Ÿæˆçš„é“¾æ¥ï¼Œå®é™…ä½¿ç”¨æ—¶è¯·ç¡®ä¿ï¼š
1. ä½¿ç”¨çœŸæ­£çš„MD5åŠ å¯†ç®—æ³•
2. å¡«å…¥æ­£ç¡®çš„å•†æˆ·IDå’Œå¯†é’¥
3. ç¡®ä¿å›è°ƒåœ°å€å¯ä»¥è¢«Z-Payè®¿é—®`, 'success');
        }

        // æµ‹è¯•ç­¾åç®—æ³•
        function testSignature() {
            const testParams = {
                name: 'iPhone XS Max ä¸€å°',
                money: '0.03',
                type: 'alipay',
                out_trade_no: '201911914837526544601',
                notify_url: 'http://www.aaa.com/notify_url.php',
                pid: '201901151314084206659771',
                param: 'é‡‘è‰² 256G',
                return_url: 'http://www.baidu.com',
                sign_type: 'MD5'
            };

            const paramString = getVerifyParams(testParams);
            const expectedSign = '28f9583617d9caf66834292b6ab1cc89'; // å®˜æ–¹ç¤ºä¾‹

            showResult(`ç­¾åç®—æ³•æµ‹è¯•ï¼š
å‚æ•°å­—ç¬¦ä¸²: ${paramString}
æœŸæœ›ç­¾å: ${expectedSign}

æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çš„æ˜¯Z-Payå®˜æ–¹æ–‡æ¡£çš„ç¤ºä¾‹æ•°æ®
å®é™…ç­¾åéœ€è¦ä½¿ç”¨çœŸæ­£çš„MD5ç®—æ³•å’Œæ­£ç¡®çš„å•†æˆ·å¯†é’¥`, 'info');
        }

        // æ¨¡æ‹Ÿå›è°ƒ
        function simulateCallback() {
            const callbackParams = {
                pid: document.getElementById('pid').value,
                name: document.getElementById('productName').value,
                money: document.getElementById('amount').value,
                out_trade_no: 'ORDER' + Date.now(),
                trade_no: '2024' + Date.now(),
                param: `ç§¯åˆ†å……å€¼-${document.getElementById('credits').value}ç§¯åˆ†`,
                trade_status: 'TRADE_SUCCESS',
                type: document.getElementById('paymentType').value,
                sign_type: 'MD5'
            };

            const paramString = getVerifyParams(callbackParams);
            const sign = md5(paramString + document.getElementById('key').value);
            callbackParams.sign = sign;

            const callbackUrl = document.getElementById('notifyUrl').value + '?' + 
                Object.keys(callbackParams).map(key => `${key}=${encodeURIComponent(callbackParams[key])}`).join('&');

            showResult(`æ¨¡æ‹Ÿå›è°ƒæ•°æ®ï¼š
å›è°ƒå‚æ•°: ${JSON.stringify(callbackParams, null, 2)}
å›è°ƒURL: ${callbackUrl}

æ³¨æ„ï¼šè¿™æ˜¯æ¨¡æ‹Ÿçš„å›è°ƒæ•°æ®ï¼Œå®é™…å›è°ƒç”±Z-Payå‘é€
å¯ä»¥ä½¿ç”¨è¿™äº›å‚æ•°æµ‹è¯•æ‚¨çš„å›è°ƒæ¥å£`, 'info');
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            showResult('Z-Pay æ”¯ä»˜æµ‹è¯•å·¥å…·å·²å°±ç»ª\nè¯·å¡«å†™ç›¸å…³å‚æ•°åç‚¹å‡»æŒ‰é’®è¿›è¡Œæµ‹è¯•', 'info');
        };
    </script>
</body>
</html>
